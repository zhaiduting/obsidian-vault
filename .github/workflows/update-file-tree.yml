name: Update README File Tree

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-tree:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install tree command
        run: sudo apt-get update && sudo apt-get install -y tree

      - name: Generate flat file list with dirs first, exclude unwanted
        run: |
          # ç”Ÿæˆåªå¸¦è·¯å¾„çš„åˆ—è¡¨ï¼Œä¸å¸¦ç¬¦å·æ ‘çŠ¶ç»“æž„ï¼Œdirsfirst
          tree --dirsfirst -if --noreport -I "node_modules|ðŸ“„ è‰ç¨¿|ðŸ—‘ï¸ åºŸçº¸ç¯“|yarn.lock|package.json|full_paths.txt" | tail -n+2 > full_paths.txt

      - name: Convert flat paths to markdown tree with links (spaces â†’ %20)
        run: |
          awk '
          function url_encode(str,    i,c,out) {
            out = ""
            for(i=1; i<=length(str); i++) {
              c = substr(str,i,1)
              if(c == " ") {
                out = out "%20"
              } else {
                out = out c
              }
            }
            return out
          }
          BEGIN { FS="/" }
          {
            if($0 == "") next
            if ($0 ~ /^[0-9]+ directories?, [0-9]+ files?$/) next
            if ($0 == ".") {
              print "."
              next
            }
            path = $0
            depth = NF - 1
            cmd = "test -d \"" path "\" && echo dir || echo file"
            cmd | getline type
            close(cmd)
            indent = depth * 2
            if(type=="dir") {
              printf "%*s- %s\n", indent, "", substr(path, length(path)-length($NF)+1)
            } else {
              encoded_path = url_encode(path)
              printf "%*s- [%s](%s)\n", indent, "", $NF, encoded_path
            }
          }
          ' full_paths.txt > tmp_tree.txt

      - name: Update README.md with file tree
        run: |
          awk '
            BEGIN { inside=0 }
            /<!-- file-tree -->/ { inside=1; print; while ((getline line < "tmp_tree.txt") > 0) print line; next }
            /<!-- file-tree-stop -->/ { inside=0; next }
            !inside { print }
          ' README.md > README.new
          mv README.new README.md

      - name: Commit and push if changes
        uses: EndBug/add-and-commit@v9
        with:
          add: README.md
          message: 'chore: update README file tree'
          default_author: github_actions
