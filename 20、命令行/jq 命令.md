## 举个例子

### 1. 检查 `jq` 已经存在

```sh
~ > which jq
/usr/bin/jq
```

### 2. 创建测试文件并写入内容

我们创建 `test.json` 文件，包含两个已存在的字段 `name` 和 `version` 以及一个嵌套的字段 `config`。

```sh
echo '{
  "name": "project_alpha",
  "version": "1.0.0",
  "config": {
    "enabled": true
  }
}' > test.json
```

### 3. 显示文件内容

```sh
~ > cat test.json
{
  "name": "project_alpha",
  "version": "1.0.0",
  "config": {
    "enabled": true
  }
}
```

### 4. 使用 `jq` 修改字段并写入新文件

我们将进行以下操作：

1. 修改 **已存在的** 字段 `version` 为 `2.0.0`。
2. 修改 **已存在的** 嵌套字段 `config.enabled` 为 `false`。
3. **添加** (即修改) **不存在的** 顶级字段 `description` 为 `"Updated project"`。

我们将使用管道 (`|`) 来链式连接这些修改操作。

```sh
# 定义一个变量用于演示 --arg 的用法
jq --arg new_version "2.0.0" \
   '.version = $new_version | .description = "Updated project" | .config.enabled = false' \
   test.json > updated_test.json
```

**命令解释：**

- `--arg new_version "2.0.0"`: 定义 `jq` 变量 `$new_version`。
- `.version = $new_version`: 修改已存在的 `version` 字段。
- `|`: 将结果传递给下一个操作。
- `.description = "Updated project"`: `description` 字段不存在，`jq` 会**自动添加**它。
- `|`: 将结果传递给下一个操作。
- `.config.enabled = false`: 修改已存在的嵌套字段。
- `test.json > updated_test.json`: 读取 `test.json`，并将修改后的结果写入 `updated_test.json`。

### 5. 显示新文件的内容

```sh
~ > cat updated_test.json
{
  "name": "project_alpha",
  "version": "2.0.0",
  "config": {
    "enabled": false
  },
  "description": "Updated project"
}
```

## `jq` 核心语法总结

`jq` 是一个强大的 JSON 处理器，其命令行结构是固定的：

```
jq [Options] '<Filter>' <Input File> [Output Redirection]
```

| **部分**                            | **示例**                    | **作用**                                                        |
| ----------------------------------- | --------------------------- | --------------------------------------------------------------- |
| **Options (选项)**                  | `--arg new_version "2.0.0"` | 用于将外部值（如 Shell 变量、字符串）传递给 `jq` 滤镜内部使用。 |
| **Filter (滤镜)**                   | `'.version = $new_version   | .description = "..."'`                                          |
| **Input File (输入文件)**           | `test.json`                 | `jq` 要读取并处理的 JSON 文件。                                 |
| **Output Redirection (输出重定向)** | `> updated_test.json`       | 将 `jq` 处理后的结果（标准输出）导入到新的文件。                |

### 1. 选项 (`Options`) 总结：外部变量注入

| **选项**    | **作用**                                                 | **示例**             | **滤镜中的引用** |
| ----------- | -------------------------------------------------------- | -------------------- | ---------------- |
| `--arg`     | 将**字符串**作为变量注入到滤镜中。                       | `--arg ver "1.2.3"`  | `$ver`           |
| `--argjson` | 将**原生 JSON 数据类型**（数字、布尔值等）作为变量注入。 | `--argjson count 10` | `$count`         |

### 2. 滤镜 (`Filter`) 总结：操作的核心

滤镜是定义数据处理逻辑的表达式。

#### A. 基础操作

| **操作符** | **作用**                             | **示例** | **结果**               |
| ---------- | ------------------------------------ | -------- | ---------------------- |
| **`.`**    | 表示当前输入的整体数据（顶层对象）。 | `.`      | 返回整个 JSON 对象。   |
| **`.key`** | 访问对象的指定键 (字段)。            | `.name`  | 返回 `project_alpha`。 |
| **`[]`**   | 访问数组元素或切片。                 | `.[0]`   | 返回数组的第一个元素。 |

#### B. 修改和赋值操作

`jq` 通过**赋值**操作 (`=`) 来实现对 JSON 数据的修改、添加和删除。

| **场景**     | **滤镜示例**           | **效果**                                    | **对应示例**              |
| ------------ | ---------------------- | ------------------------------------------- | ------------------------- |
| **修改**     | `.key = <新值>`        | 更改**已存在**字段的值。                    | `.version = $new_version` |
| **新增**     | `.new_key = <值>`      | 如果字段**不存在**，`jq` 会自动添加该字段。 | `.description = "..."`    |
| **修改嵌套** | `.parent.child = <值>` | 修改嵌套对象内的字段。                      | `.config.enabled = false` |

#### C. 滤镜的连接 (链式操作)

在进行连续的赋值操作时，我们使用**管道符 `|`** 来连接，这能确保前一个操作的**完整结果**作为后一个操作的**输入**。

| **连接符**     | **作用**                                             | **示例**                                                         | **解释**                                |
| -------------- | ---------------------------------------------------- | ---------------------------------------------------------------- | --------------------------------------- |
| \*\*`          | ` (管道)\*\*                                         | 将前一个表达式的输出作为后一个表达式的输入。**（赋值场景推荐）** | `A                                      |
| **`;` (分号)** | 按顺序执行多个表达式，但**不**改变后续表达式的输入。 | `.name, .version`                                                | 分别输出 `name` 的值和 `version` 的值。 |

**我们示例中的链式修改：**

```
.version = $new_version           # 1. 修改 version
|                                 # 2. 将修改后的整个对象作为输入
.description = "Updated project"  # 3. 在此对象上添加 description
|                                 # 4. 将再次修改后的对象作为输入
.config.enabled = false           # 5. 在此对象上修改嵌套字段
```

最终，`jq` 只输出经过所有操作处理后的**单个完整 JSON 对象**。
