### `git stash -u` 与不加 `-u` 的区别

如果想隐藏所有修改（包括 .gitignore 指定忽略的文件在内），请改用 `-a` 选项。还有一个比较麻烦的 `-k` 选项

| 特性                         | `git stash` (默认)          | `git stash -u`          |
| ---------------------------- | --------------------------- | ----------------------- |
| **已暂存的更改** (Staged)    | 存储                        | 存储                    |
| **未暂存的更改** (Unstaged)  | 存储                        | 存储                    |
| **未跟踪的文件** (Untracked) | **不**存储                  | **存储**                |
| **忽略的文件** (Ignored)     | **不**存储                  | **不**存储              |
| **工作区状态**               | 干净 (只剩未跟踪和忽略文件) | 非常干净 (只剩忽略文件) |

### `git stash pop` 与 `apply` 的区别

| 特性         | `git stash pop`          | `git stash apply`        |
| ------------ | ------------------------ | ------------------------ |
| **恢复更改** | 是                       | 是                       |
| **保留存储** | **否**（成功时删除）     | **是**（保留在列表中）   |
| **用途**     | 一次性使用，恢复并清理   | 重复使用，恢复但不清理   |
| **默认目标** | 最近的存储 (`stash@{0}`) | 最近的存储 (`stash@{0}`) |
| **安全性**   | 恢复成功后列表会被修改   | 列表不变，更安全         |

### 命令汇总

| 命令                                    | 说明                                                                                                      |
| --------------------------------------- | --------------------------------------------------------------------------------------------------------- |
| **`git stash`**                         | 将**已跟踪**文件的**已暂存和未暂存**的更改保存到新的存储记录中（`stash@{0}`）。等同于 `git stash push`。  |
| **`git stash list`**                    | 显示当前仓库中所有可用的存储记录列表。                                                                    |
| **`git stash show`**                    | 默认显示最新存储记录 (`stash@{0}`) 的**摘要**（添加、修改的文件列表）。可添加 `-p` 或 `-v` 查看详细内容。 |
| **`git stash pop`**                     | 应用最新的存储记录 (`stash@{0}`) 到工作目录，并在成功应用后**从列表中删除**该记录。                       |
| **`git stash apply`**                   | 应用最新的存储记录 (`stash@{0}`) 到工作目录，但**保留**该记录在列表中。                                   |
| **`git stash clear`**                   | **永久删除**所有存储记录，清空整个存储栈。                                                                |
| **`git stash drop`**                    | 删除最新的存储记录 (`stash@{0}`)。可以指定索引，如 `git stash drop stash@{1}`。                           |
| **`git stash push [file1] [file2]...`** | 将**指定文件**的更改存储起来。这是一种更精确的存储方式。                                                  |
| **`git stash -p`**                      | 启动**交互式**会话（patch mode），允许您逐个补丁块地选择要存储或保留的更改。                              |

如果没有冲突，那么 `git stash pop` 的执行效果相当于以下两条命令

```sh
git stash apply
git stash drop stash@{0}
```

以下命令已被弃用，因为它的作用和现在的 `git stash push`（简写为 `git stash`）是一样的

```sh
git stash save # ⚠️ 弃用
```

### 使用场景

#### 改动迁移

打算在dev分支上开发的，但不小心在main分支上改动了代码。此时可以通过 `git stash` 将改动的代码迁移到dev上，并恢复main到最近的提交点。

```sh
git stash -u
git checkout dev
git stash pop

```

#### 解决冲突

远程分支与本地代码有冲突，但又不想使用 `git merge` 或者 `git rebase` 命令。此时可以考虑 `git stash` 命令

```sh
git stash
git pull
git stash pop # 此命令会失败
```

执行pop命令时，会因为代码冲突导致失败，最终仍然需要手动解决冲突。

这种情况使用 `stash` 方式的好处是：将**远程合并**和**本地修改恢复**分成了两个清晰的阶段，可能有助于集中注意力。

#### 临时运行历史版本

假设修改了一些文件（HEAD位于点A），突然想返回到某个历史版本B运行一下代码以查看执行效果，最后继续修改之前修改的代码（要求HEAD仍然位于A）。

```sh
git stash -u
git checkout B
# 运行代码和测试...
git checkout A
git stash pop
```

### 图形界面
以GoLand为例，展示stash的图形界面的操作方法。
#### 「Git » 隐藏更改」

![git stash](https://lib.zhaiduting.work.gd/uPic/git%20stash.png)

点击左侧边栏的第2个按钮 » 在**提交**窗格的任意位置点击鼠标右键 » 在弹出的菜单中选择 Git » 隐藏更改。这相当于执行了以下命令

```sh
git stash
```

如果隐藏时**勾选了保留索引**，则相当于执行以下命令

```sh
git stash -k
```

⚠️ 两种情况都 **不会 stash 未跟踪文件**，除非手动在终端执行 `git stash -u`

#### 「Git » 取消隐藏」

![git stash pop](https://lib.zhaiduting.work.gd/uPic/git%20stash%20pop.png)

隐藏之后，在提交窗格右侧的搁置窗格的右侧，会多出一个储藏选项卡，点击储藏 » 点击弹出或者应用按钮。这相当于执行

```sh
git stash pop # 或者 apply
```
