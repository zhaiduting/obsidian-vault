# ChatGPT 编写

```sh
#!/bin/bash

mirrors=(
  "docker.m.daocloud.io"
  "docker.1ms.run"
  "mirror.ccs.tencentyun.com"
  "docker.xuanyuan.me"
)

for mirror in "${mirrors[@]}"; do
  echo -e "\n\033[1;34m== 测试对象: $mirror ==\033[0m"


  curl -s -o /dev/null -w "状态: %{http_code} | 响应耗时: %{time_total}s\n" \
    "https://$mirror/v2/"


  token_json=$(curl -s "https://$mirror/auth/token?service=$mirror&scope=repository:library/alpine:pull")

  # 判断是否为标准库 (检查 JSON 中是否存在 token 字段)
  if ! echo "$token_json" | jq -e '.token' >/dev/null 2>&1; then
    echo "结果: ❌ 认证失败或非标准 Registry"
    continue
  fi

  # 提取 Token 并测试实际 Blob 下载速度
  token=$(echo "$token_json" | jq -r .token)
  curl -L -o /dev/null -w "下载测试: 成功 | 数据传输耗时: %{time_total}s\n" \
    -H "Authorization: Bearer $token" \
    "https://$mirror/v2/library/alpine/blobs/sha256:f6b4fb9446345fcad2db26eac181fef6c0a919c8a4fcccd3bea5deb7f6dff67e"
done
```

# DeepSeek 解读

这是一个用于**测试多个 Docker 镜像源速度和可用性**的 Bash 脚本。让我详细解释每个部分：

## 脚本功能概述

该脚本会遍历多个 Docker 镜像仓库，依次检查：

1. 基础连通性
2. 认证接口兼容性
3. 实际下载速度

## 详细解析

### 1. 镜像源列表

```sh
mirrors=(
  "docker.m.daocloud.io"      # 道客加速器
  "docker.1ms.run"            # 阿里云镜像（旧版）
  "mirror.ccs.tencentyun.com" # 腾讯云镜像
  "docker.xuanyuan.me"        # 第三方镜像站
)
```

定义了要测试的镜像源数组，每个都是国内的 Docker Hub 镜像加速器。

### 2. 主循环测试逻辑

对每个镜像源执行以下测试：

#### a) 基础连通性测试

```sh
curl -s -o /dev/null -w "状态: %{http_code} | 响应耗时: %{time_total}s\n" \
  "https://$mirror/v2/"
```

- `-s`: 静默模式（不显示进度）
- `-o /dev/null`: 丢弃响应内容
- `-w`: 输出格式化的结果
- 测试 `/v2/` 端点（Docker Registry API v2）

#### b) 获取认证 Token

```sh
token_json=$(curl -s "https://$mirror/auth/token?service=$mirror&scope=repository:library/alpine:pull")
```

请求获取拉取 `alpine` 镜像的认证令牌。

#### c) 验证是否为标准 Registry

```sh
if ! echo "$token_json" | jq -e '.token' >/dev/null 2>&1; then
```

使用 `jq` 工具检查返回的 JSON 是否包含 `token` 字段，如果不包含则说明：

- 认证失败
- 或者这不是标准的 Docker Registry

#### d) 实际下载速度测试

```sh
token=$(echo "$token_json" | jq -r .token)
curl -L -o /dev/null -w "下载测试: 成功 | 数据传输耗时: %{time_total}s\n" \
  -H "Authorization: Bearer $token" \
  "https://$mirror/v2/library/alpine/blobs/sha256:..."
```

- 提取 token
- 使用 token 下载一个具体的 Alpine 镜像 layer（blob）
- 测量实际数据传输耗时

## 脚本用途

1. **对比镜像源速度**：选择最快的 Docker 镜像加速器
2. **检查镜像源可用性**：确认哪些镜像源工作正常
3. **诊断网络问题**：排查 Docker 拉取镜像慢的问题

## 使用前准备

需要安装依赖：

```sh
# Ubuntu/Debian
sudo apt-get install curl jq

# CentOS/RHEL
sudo yum install curl jq
```

## 输出示例

脚本会输出类似这样的结果：

```sh
== 测试对象: docker.m.daocloud.io ==
状态: 401 | 响应耗时: 1.134224s
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   472  100   472    0     0   1029      0 --:--:-- --:--:-- --:--:--  1030
100 4097k  100 4097k    0     0  1402k      0  0:00:02  0:00:02 --:--:-- 2114k
下载测试: 成功 | 数据传输耗时: 2.920681s

== 测试对象: docker.1ms.run ==
状态: 401 | 响应耗时: 1.506933s
结果: ❌ 认证失败或非标准 Registry

== 测试对象: mirror.ccs.tencentyun.com ==
状态: 000 | 响应耗时: 1.363609s
结果: ❌ 认证失败或非标准 Registry

== 测试对象: docker.xuanyuan.me ==
状态: 429 | 响应耗时: 2.466311s
结果: ❌ 认证失败或非标准 Registry

```

通过这个脚本，用户可以快速找到当前网络环境下最快的 Docker 镜像源。
