---
author:
  - zhaiduting@163.com
created: 2025-06-16
tags:
  - åŸåˆ›
---

å°†æ–‡æœ¬æ–‡ä»¶åˆæˆ mp3 éŸ³é¢‘çš„åŒæ—¶ï¼Œè¿˜èƒ½è‡ªåŠ¨ç”Ÿæˆæ­Œè¯ã€‚è¿™æ ·å°±å¯ä»¥å¯¼å…¥éŸ³ä¹æ’­æ”¾å™¨é‡Œé¢éšæ„è·³è½¬æ’­æ”¾äº†ï¼

```shell
#!/bin/bash

# ğŸ§ª Step 0: ç”Ÿæˆæµ‹è¯•ç”¨çš„å¸¦ <mark> çš„ SSML æ–‡ä»¶ï¼ˆå¦‚æœªå­˜åœ¨ï¼‰
test_file="sample.txt"
if [ ! -f "$test_file" ]; then
cat > "$test_file" <<EOF
<speak>Hello <mark name='timepoint_1'/> Mark. Good to <mark name='timepoint_2'/> see you.</speak>
EOF
  echo "âœ… å·²ç”Ÿæˆæµ‹è¯•ç”¨æ–‡æœ¬ï¼š$test_file"
fi

# Step 1: è·å–è¾“å…¥æ–‡ä»¶å
if [ -z "$1" ]; then
  read -p "è¯·è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬æ–‡ä»¶å: " input_file
else
  input_file="$1"
fi

# Step 2: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”éç©º
if [ ! -f "$input_file" ] || [ ! -s "$input_file" ]; then
  echo "é”™è¯¯ï¼šæ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º: $input_file"
  exit 1
fi

# Step 3: è·å–è®¿é—®ä»¤ç‰Œ
access_token=$(gcloud auth print-access-token 2>/dev/null)
if [ -z "$access_token" ]; then
  echo "é”™è¯¯ï¼šæ— æ³•è·å–è®¿é—®ä»¤ç‰Œï¼Œè¯·å…ˆè¿è¡Œï¼šgcloud auth login"
  exit 1
fi

# Step 4: æ„é€ è¯·æ±‚ä½“
# ç›´æ¥ä»æ–‡ä»¶è¯»å– SSML å†…å®¹ï¼Œå¹¶ä½¿ç”¨ jq å®‰å…¨åœ°å°†å…¶åµŒå…¥ JSON
ssml_content=$(cat "$input_file")

request_json=$(jq -n --arg ssml_text "$ssml_content" '
{
  "enableTimePointing": ["SSML_MARK"],
  "input": {
    "ssml": $ssml_text
  },
  "voice": {
    "languageCode": "en-GB",
    "name": "en-GB-Standard-A",
    "ssmlGender": "FEMALE"
  },
  "audioConfig": {
    "audioEncoding": "MP3"
  }
}' | tr -d '\n') # ç¡®ä¿è¾“å‡ºä¸ºå•è¡Œï¼Œé¿å… curl ä¼ è¾“é—®é¢˜

# Step 5: æ–‡ä»¶åå®šä¹‰
response_json="${input_file}.tts.response.json"
audio_base64="${input_file}.tts.audio.b64"
output_mp3="${input_file}.mp3"
output_lrc="${input_file}.lrc"

# Step 6: å‘é€è¯·æ±‚
echo "æ­£åœ¨å‘é€è¯·æ±‚åˆ° Google Cloud Text-to-Speech API..."
curl -s -X POST \
  -H "Authorization: Bearer $access_token" \
  -H "x-goog-user-project: zdt-tts-try" \
  -H "Content-Type: application/json; charset=utf-8" \
  -d "$request_json" \
  "https://texttospeech.googleapis.com/v1beta1/text:synthesize" \
  -o "$response_json"

# Step 7: æ£€æŸ¥å“åº”ä¸­æ˜¯å¦æœ‰ audioContent
audio_content=$(jq -r '.audioContent' "$response_json")
if [ -z "$audio_content" ] || [ "$audio_content" == "null" ]; then
  echo "é”™è¯¯ï¼šå“åº”ä¸­æœªåŒ…å«éŸ³é¢‘å†…å®¹ï¼ˆaudioContent ä¸ºç©ºï¼‰ã€‚"
  echo "API å“åº”è¯¦æƒ…ï¼š"
  cat "$response_json" # æ‰“å°å®Œæ•´çš„å“åº” JSON ä»¥ä¾¿è°ƒè¯•
  exit 1
fi

# Step 8: æå–éŸ³é¢‘å¹¶è½¬ä¸º MP3
echo "$audio_content" > "$audio_base64"
base64 -D -i "$audio_base64" -o "$output_mp3"
echo "âœ… æˆåŠŸç”ŸæˆéŸ³é¢‘æ–‡ä»¶ï¼š$output_mp3"

# Step 9: ç”Ÿæˆ LRC æ–‡ä»¶
echo "æ­£åœ¨ç”Ÿæˆ .lrc æ–‡ä»¶..."
jq -r '.timepoints[] | "\(.timeSeconds) \(.markName)"' "$response_json" | \
awk '{
    time_seconds = $1;
    mark_name = "";
    for (i = 2; i <= NF; i++) {
        mark_name = mark_name " " $i;
    }
    mark_name = substr(mark_name, 2); # Remove leading space

    minutes = int(time_seconds / 60);
    seconds = int(time_seconds % 60); # ä½¿ç”¨ % è¿ç®—ç¬¦ä»£æ›¿ fmod
    milliseconds = int((time_seconds - int(time_seconds)) * 100); # æå–å°æ•°éƒ¨åˆ†å¹¶è½¬æ¢ä¸ºä¸¤ä½æ¯«ç§’

    printf "[%02d:%02d.%02d]%s\n", minutes, seconds, milliseconds, mark_name;
}' > "$output_lrc"

echo "âœ… æˆåŠŸç”Ÿæˆæ—¶é—´æ ‡è®°æ–‡ä»¶ï¼š$output_lrc"

# Step 10: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -f "$response_json" "$audio_base64"
```
