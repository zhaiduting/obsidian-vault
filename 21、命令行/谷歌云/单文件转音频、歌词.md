---
author:
  - zhaiduting@163.com
created: 2025-06-16
tags:
  - 原创
---

将文本文件合成 mp3 音频的同时，还能自动生成歌词。这样就可以导入音乐播放器里面随意跳转播放了！

```shell
#!/bin/bash
# Description: Synthesizes speech from an SSML file using Google Cloud Text-to-Speech API
#              and generates MP3 audio and an LRC file with timepoints.
# Usage: tts2.sh <input_ssml_file>

# Step 1: Get input filename (must be an SSML file)
if [ -z "$1" ]; then
  read -p "请输入要转换的 SSML 文件名: " input_file
else
  input_file="$1"
fi

# Step 2: Check if file exists and is not empty, and if it looks like SSML
if [ ! -f "$input_file" ] || [ ! -s "$input_file" ]; then
  echo "Error: File does not exist or is empty: $input_file"
  exit 1
fi

if ! grep -q "<speak>" "$input_file"; then
  echo "Error: Input file does not appear to be an SSML file (missing <speak> tag): $input_file"
  echo "Please use 'txt2ssml.sh' first to convert your text file to SSML."
  exit 1
fi

# Define output filenames based on input file base name
base_name="${input_file%.*}" # Removes .ssml extension
response_json="${base_name}.tts.response.json"
audio_base64="${base_name}.tts.audio.b64"
output_mp3="${base_name}.mp3"
output_lrc="${base_name}.lrc"

# Step 3: Get access token
access_token=$(gcloud auth print-access-token 2>/dev/null)
if [ -z "$access_token" ]; then
  echo "Error: Could not obtain access token. Please run: gcloud auth login"
  exit 1
fi

# Step 4: Construct request body from SSML file
ssml_content=$(cat "$input_file")
request_json=$(jq -n --arg ssml_text "$ssml_content" '
{
  "enableTimePointing": ["SSML_MARK"],
  "input": {
    "ssml": $ssml_text
  },
  "voice": {
    "languageCode": "en-GB",
    "name": "en-GB-Standard-A",
    "ssmlGender": "FEMALE"
  },
  "audioConfig": {
    "audioEncoding": "MP3"
  }
}' | tr -d '\n')

# Step 5: Send request
echo "Sending request to Google Cloud Text-to-Speech API..."
curl -s -X POST \
  -H "Authorization: Bearer $access_token" \
  -H "x-goog-user-project: zdt-tts-try" \
  -H "Content-Type: application/json; charset=utf-8" \
  -d "$request_json" \
  "https://texttospeech.googleapis.com/v1beta1/text:synthesize" \
  -o "$response_json"

# Step 6: Check for audio content in response
audio_content=$(jq -r '.audioContent' "$response_json")
if [ -z "$audio_content" ] || [ "$audio_content" == "null" ]; then
  echo "Error: Response did not contain audio content (audioContent is empty)."
  echo "API Response Details:"
  cat "$response_json"
  exit 1
fi

# Step 7: Extract audio and convert to MP3
echo "$audio_content" > "$audio_base64"
base64 -D -i "$audio_base64" -o "$output_mp3"
echo "✅ Successfully generated audio file: $output_mp3"

# Step 8: Generate LRC file
echo "Generating .lrc file..."

# 提取 timepoints 为 Bash 数组（兼容 macOS）
marks=()
while IFS= read -r line; do
  marks+=("$line")
done < <(jq -r '.timepoints[] | "\(.markName) \(.timeSeconds)"' "$response_json")

# 读取原始 SSML 内容，去除 <speak> 标签
ssml_text=$(<"$input_file")
ssml_text="${ssml_text//<speak>/}"
ssml_text="${ssml_text//<\/speak>/}"

# 拆分文本为数组，每一项是 <mark name='...'/> 前的文字
IFS=$'\n' read -d '' -r -a text_segments < <(
  echo "$ssml_text" | awk '
    BEGIN {
      RS = "<mark name='\''[^'\'']+'\''/>"
      ORS = ""
      count = 0
    }
    {
      gsub(/^[ \t\r\n]+|[ \t\r\n]+$/, "", $0);
      if (count++) print "\n" $0;
      else print $0;
    }
    END { print "\n" }
  ' && printf '\0'
)

# 输出 .lrc 文件
: > "$output_lrc"
for i in "${!marks[@]}"; do
  mark="${marks[$i]}"
  mark_name="${mark%% *}"
  time="${mark#* }"
  lyric="${text_segments[$i]}"

  # 使用 awk 进行时间格式化
  timestamp=$(awk -v t="$time" 'BEGIN {
    m = int(t / 60);
    s = int(t % 60);
    ms = int((t - int(t)) * 100);
    printf "[%02d:%02d.%02d]", m, s, ms
  }')

  echo "$timestamp$lyric" >> "$output_lrc"
done

echo "✅ Successfully generated time-marked file: $output_lrc"

# Step 9: Clean up temporary files
rm -f "$response_json" "$audio_base64"
```
